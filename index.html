<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArtBroke - Galería de Arte</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --card-width: 90vw;
            --card-height: 85vh;
            --primary-color: #121212;
            --secondary-color: #e60023;
            --text-color: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background-color: var(--primary-color);
            color: var(--text-color);
            height: 100vh;
        }
        .scroller-container {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
        }
        .scroller-item {
            width: 100vw;
            height: 100vh;
            scroll-snap-align: start;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .artwork-card {
            width: var(--card-width);
            height: var(--card-height);
            border-radius: 16px;
            overflow: hidden;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            background-color: #000;
        }
        .artwork-image {
            width: 100%; height: 100%; object-fit: contain;
        }
        .info-card {
            width: var(--card-width); height: var(--card-height);
            background: linear-gradient(135deg, #2c3e50, #1a1a2e);
            border-radius: 16px; padding: 25px;
            position: absolute; left: 100vw; top: 50%;
            transform: translateY(-50%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto;
        }
        .artwork-card.show-info + .info-card { transform: translateX(-100vw) translateY(-50%); }
        .info-card h3 { border-bottom: 2px solid var(--secondary-color); padding-bottom: 15px; font-size: 1.8rem; margin-bottom: 20px; }
        .info-card p { margin: 12px 0; font-size: 1.1rem; line-height: 1.5; }
        .header {
            position: fixed; top: 0; left: 0; width: 100%; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .logo { font-size: 1.5rem; font-weight: bold; }
        .logo span { color: var(--secondary-color); }
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .user-profile img { width: 40px; height: 40px; border-radius: 50%; }
        #login-btn, #logout-btn { background-color: var(--secondary-color); color: white; border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background-color: var(--primary-color); z-index: 1000; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: var(--secondary-color); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .action-buttons { position: absolute; right: calc((100vw - var(--card-width)) / 2 + 20px); bottom: 100px; display: flex; flex-direction: column; gap: 20px; z-index: 10;}
        .action-button { display: flex; flex-direction: column; align-items: center; color: white; font-size: 0.8rem; cursor: pointer; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .action-button i { font-size: 1.8rem; margin-bottom: 5px; transition: transform 0.2s, color 0.2s; }
        .action-button .fa-heart.liked { color: var(--secondary-color); }
        .artist-info { position: absolute; bottom: 30px; left: calc((100vw - var(--card-width)) / 2 + 20px); max-width: 60%; z-index: 10; text-shadow: 0 1px 3px rgba(0,0,0,0.8);}
        
        /* Modal de Comentarios */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background-color: #2c3e50; margin: 15% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .comments-list { max-height: 300px; overflow-y: auto; margin-bottom: 20px; }
        .comment { padding: 10px; border-bottom: 1px solid #444; }
        .comment strong { color: var(--secondary-color); }
        .comment-form { display: flex; gap: 10px; }
        .comment-form input { flex-grow: 1; padding: 10px; border-radius: 20px; border: none; background-color: #1a1a2e; color: white; }
        .comment-form button { background: var(--secondary-color); border: none; color: white; padding: 10px 15px; border-radius: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="loading"><div class="spinner"></div><p>Cargando obras de arte...</p></div>
    <div class="header">
        <div class="logo">Art<span>Broke</span></div>
        <div id="user-auth-container"></div>
    </div>
    <div class="scroller-container"></div>

    <!-- Modal de Comentarios -->
    <div id="comments-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Comentarios</h2>
        <div class="comments-list" id="modal-comments-list"></div>
        <form id="comment-form" class="comment-form">
          <input type="text" id="comment-input" placeholder="Añade un comentario..." required>
          <button type="submit">Enviar</button>
        </form>
      </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      
        const firebaseConfig = {
            apiKey: "AIzaSyAlJyGAHYv30n2TOayKy3JwFTYw_RxT5N8",
            authDomain: "artbroke-306d1.firebaseapp.com",
            projectId: "artbroke-306d1",
            storageBucket: "artbroke-306d1.appspot.com",
            messagingSenderId: "394124927983",
            appId: "1:394124927983:web:31ac480d2de6df2ebb0c1a"
        };
      
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
      
        let currentUser = null;
        const scrollerContainer = document.querySelector('.scroller-container');
        const loadingElement = document.querySelector('.loading');
        const userAuthContainer = document.getElementById('user-auth-container');
        const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbwr4iTtxx4ZRBYD-X8gFgN7P8CYZT7oedMnAu4LzO06QqR6XHmaIhOWLvqILwWsBbtp/exec';
        let artworksData = [];

        // --- MANEJO DE AUTENTICACIÓN ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateUIForAuthState(user);
            fetchArtworks();
        });

        function updateUIForAuthState(user) {
            if (user) {
                userAuthContainer.innerHTML = `
                    <div class="user-profile">
                        <img src="${user.photoURL}" alt="Foto de perfil">
                        <span>${user.displayName}</span>
                        <button id="logout-btn">Salir</button>
                    </div>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            } else {
                userAuthContainer.innerHTML = `<button id="login-btn">Iniciar Sesión con Google</button>`;
                document.getElementById('login-btn').addEventListener('click', () => signInWithPopup(auth, provider));
            }
        }

        // --- LÓGICA DE LA APLICACIÓN ---
        async function fetchArtworks() {
            loadingElement.style.display = 'flex';
            const url = currentUser ? `${appsScriptUrl}?userId=${currentUser.uid}` : appsScriptUrl;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Error en la respuesta del servidor');
                artworksData = await response.json();
                renderArtworks(artworksData);
            } catch (error) {
                console.error('Error al obtener los datos:', error);
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        function renderArtworks(artworks) {
            scrollerContainer.innerHTML = '';
            artworks.forEach((artwork) => {
                const scrollerItem = document.createElement('div');
                scrollerItem.classList.add('scroller-item');
                scrollerItem.innerHTML = `
                    <div class="artwork-card">
                        <img src="${artwork.URL_Imagen}" class="artwork-image" alt="${artwork.Titulo}">
                    </div>
                    <div class="info-card">
                        <h3>${artwork.Titulo}</h3>
                        <p><strong>Autor:</strong> ${artwork.Autor}</p>
                        <p><strong>Descripción:</strong> ${artwork.Descripcion}</p>
                    </div>
                    <div class="artist-info">
                        <h4>${artwork.Titulo}</h4>
                        <p>@${artwork.Autor}</p>
                    </div>
                    <div class="action-buttons">
                        <div class="action-button" id="like-btn-${artwork.ID_Obra}">
                            <i class="fas fa-heart ${artwork.userHasLiked ? 'liked' : ''}"></i>
                            <span id="like-count-${artwork.ID_Obra}">${artwork.likes}</span>
                        </div>
                        <div class="action-button" id="comment-btn-${artwork.ID_Obra}">
                            <i class="fas fa-comment"></i>
                            <span id="comment-count-${artwork.ID_Obra}">${artwork.comments.length}</span>
                        </div>
                    </div>
                `;
                scrollerContainer.appendChild(scrollerItem);
            });
            addEventListeners();
        }

        function addEventListeners() {
            document.querySelectorAll('.artwork-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.action-buttons')) {
                        card.classList.toggle('show-info');
                    }
                });
            });

            document.querySelectorAll('.action-button[id^="like-btn-"]').forEach(button => {
                button.addEventListener('click', handleLikeClick);
            });
            
            document.querySelectorAll('.action-button[id^="comment-btn-"]').forEach(button => {
                button.addEventListener('click', handleCommentClick);
            });
        }
        
        // --- MANEJO DE ACCIONES ---
        async function handleLikeClick(event) {
            if (!currentUser) {
                alert('Debes iniciar sesión para dar me gusta.');
                return;
            }
            const button = event.currentTarget;
            const artworkId = button.id.split('-')[2];
            const icon = button.querySelector('i');
            const countSpan = button.querySelector('span');
            const isLiked = icon.classList.toggle('liked');

            // Actualización optimista de la UI
            let currentLikes = parseInt(countSpan.textContent);
            countSpan.textContent = isLiked ? currentLikes + 1 : currentLikes - 1;

            // Enviar al backend
            try {
                await fetch(appsScriptUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'toggleLike',
                        artworkId: artworkId,
                        user: { uid: currentUser.uid }
                    })
                });
                // Podrías volver a cargar los datos para confirmar, pero la actualización optimista es más rápida.
            } catch (error) {
                console.error("Error al dar like:", error);
                // Revertir el cambio si falla
                icon.classList.toggle('liked');
                countSpan.textContent = currentLikes;
            }
        }
        
        function handleCommentClick(event) {
            const button = event.currentTarget;
            const artworkId = button.id.split('-')[2];
            openCommentsModal(artworkId);
        }

        // --- LÓGICA DEL MODAL DE COMENTARIOS ---
        const modal = document.getElementById('comments-modal');
        const closeBtn = document.querySelector('.close-btn');
        const commentForm = document.getElementById('comment-form');
        const commentsList = document.getElementById('modal-comments-list');
        const commentInput = document.getElementById('comment-input');
        let currentArtworkIdForComment = null;

        closeBtn.onclick = () => { modal.style.display = "none"; }
        window.onclick = (event) => { if (event.target == modal) { modal.style.display = "none"; } }

        function openCommentsModal(artworkId) {
            currentArtworkIdForComment = artworkId;
            const artwork = artworksData.find(art => art.ID_Obra == artworkId);
            commentsList.innerHTML = '';
            if (artwork && artwork.comments.length > 0) {
                artwork.comments.forEach(comment => {
                    const div = document.createElement('div');
                    div.classList.add('comment');
                    div.innerHTML = `<p><strong>${comment.userName}:</strong> ${comment.commentText}</p>`;
                    commentsList.appendChild(div);
                });
            } else {
                commentsList.innerHTML = '<p>No hay comentarios todavía. ¡Sé el primero!</p>';
            }
            modal.style.display = "block";
        }

        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                alert('Debes iniciar sesión para comentar.');
                return;
            }
            const commentText = commentInput.value;
            if (!commentText.trim()) return;

            const button = e.target.querySelector('button');
            button.disabled = true;
            button.textContent = 'Enviando...';

            try {
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'addComment',
                        artworkId: currentArtworkIdForComment,
                        commentText: commentText,
                        user: { uid: currentUser.uid, displayName: currentUser.displayName }
                    })
                });
                const result = await response.json();
                if(result.status === 'success') {
                    // Añadir el nuevo comentario a la lista visualmente
                    const div = document.createElement('div');
                    div.classList.add('comment');
                    div.innerHTML = `<p><strong>${result.newComment.userName}:</strong> ${result.newComment.commentText}</p>`;
                    if(commentsList.querySelector('p')?.textContent.includes('No hay comentarios')) {
                        commentsList.innerHTML = '';
                    }
                    commentsList.appendChild(div);
                    commentInput.value = '';

                    // Actualizar el contador de comentarios en la tarjeta principal
                    const countSpan = document.getElementById(`comment-count-${currentArtworkIdForComment}`);
                    countSpan.textContent = parseInt(countSpan.textContent) + 1;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error al añadir comentario:', error);
                alert('No se pudo enviar el comentario.');
            } finally {
                button.disabled = false;
                button.textContent = 'Enviar';
            }
        });

    </script>
</body>
</html>
